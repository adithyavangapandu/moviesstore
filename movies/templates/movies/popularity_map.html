{% extends 'base.html' %}

{% block extra_head %}
    <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
    />

    <style>
    #local-popularity-map {
        width: 100%;
        min-height: 520px;
        border-radius: 12px;
        border: 1px solid #d9d9d9;
    }
    .legend-dot {
        width: 11px;
        height: 11px;
        border-radius: 100%;
        display: inline-block;
        margin-right: 6px;
    }
    </style>
{% endblock %}



{% block content %}


<div class="container">

    <label class="form-label" for="region">Region</label>
    <select class="form-select" id="region" name="region">
        <option value="">All Regions</option>
        {% for region in template_data.regions %}
        <option value="{{ region }}">{{ region }}</option>
        {% endfor %}
    </select>

    <label class="form-label" for="state">State</label>
    <select class="form-select" id="state" name="state">
        <option value="">All States</option>
        {% for state in template_data.states %}
        <option value="{{ state }}">{{ state }}</option>
        {% endfor %}
    </select>

    <label class="form-label" for="city">City</label>
    <select class="form-select" id="city" name="city">
        <option value="">All Cities</option>
        {% for city in template_data.cities %}
        <option value="{{ city }}">{{ city }}</option>
        {% endfor %}
    </select>

    <div class="row g-3 mt-2">
        <div class="col-lg-8">
            <div id="local-popularity-map"></div>
        </div>

        <div class="col-lg-4">
            <div id="top-movies-panel" style="border: 1px solid #d9d9d9; border-radius: 12px; padding: 14px;">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:12px">
                    <h5 style="margin:0;">Trending Movies</h5>
                    <span id="top-movies-count" style="font-size:0.9rem; opacity:0.75;"></span>
                </div>

                <div id="top-movies-list" style="margin-top: 12px;"></div>

        </div>
    </div>
</div>

<div id="map-config"
     data-filter-url="{% url 'local_popularity_filter_data' %}">
</div>
{% endblock %}

{% block extra_scripts %}
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>

    const map = L.map("local-popularity-map", {
        scrollWheelZoom: true,
    });

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    const markersLayer = L.layerGroup().addTo(map);

    const movies_count = document.getElementById("top-movies-count");
    const movies_list = document.getElementById("top-movies-list");


    const region_input = document.getElementById("region");
    const state_input = document.getElementById("state");
    const city_input = document.getElementById("city");

    const filterUrl = document.getElementById("map-config").dataset.filterUrl;

    function cityEnabled() {
        return Boolean(region_input.value) || Boolean(state_input.value);
    }

    function enforceCityRule() {
        const enabled = cityEnabled();
        city_input.disabled = !enabled;

        if (!enabled && city_input.value !== "") {
            city_input.value = "";
        }

    }


    function renderTopMovies(movies) {
        if (!movies_list) return;

        if (!movies || movies.length === 0) {
            movies_count.textContent = "";
            movies_list.innerHTML = `<div style="opacity:0.75;">No purchases</div>`;
            return;
        }

        movies_count.textContent = `${movies.length} shown`;

        movies_list.innerHTML = movies.map((m, idx) => {
            const units = m.total_units;
            const orders = m.num_orders;

            return `
                <div style="display:flex; justify-content:space-between; gap:12px; padding:10px 0; border-bottom:1px solid #eee;">
                    <div style="min-width:0;">
                    <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                        ${idx + 1}. ${m.movie_name}
                    </div>
                    <div style="font-size:0.9rem; opacity:0.75;">
                        ${orders !== null ? `${orders} orders` : ``}
                    </div>
                    </div>

                    <div style="text-align:right;">
                    <div style="font-weight:700;">${units}</div>
                    <div style="font-size:0.85rem; opacity:0.7;">units</div>
                    </div>
                </div>
                `;
        }).join("");
    }
    function renderMarkers(markers) {
        markersLayer.clearLayers();
        const bounds = [];
        markers.forEach((marker) => {
            const coordinates = [marker.lat, marker.lon];
            bounds.push(coordinates);
            let color = '#00ff00'
            if (marker.is_current_user) {
                color = '#ff0000'
            }

            L.circleMarker(coordinates, {
                radius: marker.is_current_user ? 8 : 6,
                color: '#ffffff',
                weight: 1,
                fillColor: color,
                fillOpacity: 0.95
            }).bindPopup(
                `<strong>${marker.username}</strong><br>${marker.city}, ${marker.state}<br>${marker.region}`
            ).addTo(markersLayer);
        })
        return bounds;
    }

    function fitView(param_bounds) {
        if (param_bounds.length === 0) {
            map.setView([33.7490, -84.3880], 11);
        } else if (param_bounds.length === 1) {
            map.setView(param_bounds[0], 11);
        } else {
            const bounds = L.latLngBounds(param_bounds);
            map.fitBounds(bounds, { padding: [40, 40] });
        }

    }

    function getFilterParams() {
        return {
            region: region_input.value || "",
            state: state_input.value || "",
            city: city_input.value || "",
        }
    }

    function fillOptions(filter, options, generalTerm, maintainVal) {
        const previous = filter.value;
        filter.innerHTML = "";
        const general = document.createElement("option");
        general.value = "";
        general.textContent = generalTerm;
        filter.appendChild(general);

        for (const value of options) {
            const opt = document.createElement("option");
            opt.value = value;
            opt.textContent = value;
            filter.appendChild(opt);
        }

        if (maintainVal && previous && options.includes(previous)) {
            filter.value = previous;
        } else {
            filter.value = "";
        }
    }
    async function fetchAndUpdate() {
        enforceCityRule();
        const params = new URLSearchParams(getFilterParams());
        const url = `${filterUrl}?${params.toString()}`

        try {
            const response = await fetch(url, {
                method: "GET",
                headers: { "Accept": "application/json"},
            });

            if (!response.ok) {
                console.error("Fetch didn't work.");
                return;
            }
            const data = await response.json();

            if (data.options) {
                fillOptions(region_input, data.options.regions, "All Regions", true);
                fillOptions(state_input, data.options.states, "All States", true);
                fillOptions(city_input, data.options.cities, "All Cities", true);
                enforceCityRule();

            }

            renderTopMovies(data.movies);
            const curr_bounds = renderMarkers(data.markers);

            fitView(curr_bounds);



        } catch (err) {
            console.error("Filter fetch error:", err);
        }
    }



    region_input.addEventListener("change", () => {
        enforceCityRule();
        fetchAndUpdate();
    })

    state_input.addEventListener("change", () => {
        enforceCityRule();
        fetchAndUpdate();
    })

    city_input.addEventListener("change", () => {

        fetchAndUpdate();
    })

    enforceCityRule();
    fetchAndUpdate();

</script>
{% endblock %}

